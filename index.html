<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ì²´í¬ìº˜ë¦°ë”</title>
  <style>
    :root{--bg:#f3f6fb;--card:#fff;--primary:#2f6bed;--accent:#2ab57a;--danger:#f06262;--muted:#6b7280}
    *{box-sizing:border-box}
    body,html{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans KR',sans-serif;background:var(--bg);color:#111}
    .wrap{max-width:980px;margin:28px auto;padding:18px}
    .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    .brand{font-weight:700;font-size:20px}
    .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 6px 18px rgba(30,40,60,0.06)}
    .btn{padding:8px 12px;border-radius:8px;border:none;background:var(--primary);color:#fff;font-weight:600;cursor:pointer}
    .btn.secondary{background:#fff;color:var(--primary);border:1px solid #dbe4fb}
    .btn.positive{background:var(--accent)}
    .btn.negative{background:var(--danger)}
    .small{font-size:13px;color:var(--muted)}
    .main{display:grid;grid-template-columns:300px 1fr;gap:16px}
    .sidebar .profile{display:flex;gap:12px;align-items:center}
    .avatar{width:48px;height:48px;border-radius:10px;background:linear-gradient(135deg,#e6f0ff,#f3f8ff);display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--primary)}
    .grid-days{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-top:8px}
    .cell{background:var(--card);border-radius:8px;padding:8px;min-height:70px;border:1px solid #eef2f6;display:flex;flex-direction:column;cursor:pointer}
    .cell.out{opacity:0.35}
    .cell:hover{transform:translateY(-4px);transition:transform .12s}
    .selected{outline:3px solid rgba(47,107,237,0.12);box-shadow:0 8px 24px rgba(47,107,237,0.06)}
    .memo-list{display:flex;flex-direction:column;gap:8px;margin-top:10px}
    .memo-item{padding:8px;border-radius:8px;background:#fbfdff;border:1px solid #eef3ff}
    .chat-window{display:flex;flex-direction:column;height:420px}
    .messages{flex:1;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:8px;border-radius:8px;border:1px solid #eef3ff;background:linear-gradient(180deg,#fff,#fbfdff)}
    .msg{padding:8px 10px;border-radius:8px;max-width:75%}
    .msg.me{align-self:flex-end;background:#e6f0ff}
    .msg.other{align-self:flex-start;background:#fff}
    @media (max-width:880px){.main{grid-template-columns:1fr}.sidebar{order:2}}
    /* modal */
    .modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.35)}
    .modal .inner{background:var(--card);padding:16px;border-radius:10px;min-width:320px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="brand">ì²´í¬ìº˜ë¦°ë”</div>
      <div id="headerActions"></div>
    </div>

    <div id="content"></div>
  </div>

<script>
const STORAGE_KEY = 'checkcalendar_v3';
let state = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
state.users = state.users || {};
state.chats = state.chats || {};
let currentUser = null;
let view = { year: new Date().getFullYear(), month: new Date().getMonth(), mode: 'calendar' };
let selectedDate = null;
let activeRoom = null;

function persist(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

// ---------- AUTH ----------
function renderAuth(){
  document.getElementById('content').innerHTML = `
    <div class="card" style="max-width:420px;margin:0 auto">
      <h3 style="margin:0 0 8px 0">ê³„ì •ìœ¼ë¡œ ì‹œì‘</h3>
      <div class="small">ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¡œ ê°„í¸í•˜ê²Œ ì´ìš©í•˜ì„¸ìš”.</div>
      <label class="small" style="margin-top:12px">ì•„ì´ë””</label>
      <input id="f_id" type="text" style="width:100%;padding:8px;border-radius:8px;border:1px solid #e6e9ef;margin-top:6px" />
      <label class="small" style="margin-top:8px">ë¹„ë°€ë²ˆí˜¸</label>
      <input id="f_pw" type="password" style="width:100%;padding:8px;border-radius:8px;border:1px solid #e6e9ef;margin-top:6px" />
      <div style="display:flex;gap:8px;margin-top:12px">
        <button class="btn" onclick="doLogin()">ë¡œê·¸ì¸</button>
        <button class="btn secondary" onclick="renderRegister()">íšŒì›ê°€ì…</button>
      </div>
      <div id="authMsg" class="small" style="margin-top:10px;color:var(--muted)"></div>
    </div>`;
  document.getElementById('headerActions').innerHTML = '';
}
function renderRegister(){
  document.getElementById('content').innerHTML = `
    <div class="card" style="max-width:420px;margin:0 auto">
      <h3 style="margin:0 0 8px 0">ìƒˆ ê³„ì • ë§Œë“¤ê¸°</h3>
      <label class="small">ì•„ì´ë””</label>
      <input id="r_id" type="text" style="width:100%;padding:8px;border-radius:8px;border:1px solid #e6e9ef;margin-top:6px" />
      <label class="small" style="margin-top:8px">ë¹„ë°€ë²ˆí˜¸</label>
      <input id="r_pw" type="password" style="width:100%;padding:8px;border-radius:8px;border:1px solid #e6e9ef;margin-top:6px" />
      <label class="small" style="margin-top:8px">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
      <input id="r_pw2" type="password" style="width:100%;padding:8px;border-radius:8px;border:1px solid #e6e9ef;margin-top:6px" />
      <div style="display:flex;gap:8px;margin-top:12px">
        <button class="btn positive" onclick="doRegister()">íšŒì›ê°€ì…</button>
        <button class="btn secondary" onclick="renderAuth()">ì·¨ì†Œ</button>
      </div>
      <div id="regMsg" class="small" style="margin-top:10px;color:var(--muted)"></div>
    </div>`;
  document.getElementById('headerActions').innerHTML = '';
}
function doRegister(){
  const id = (document.getElementById('r_id').value || '').trim();
  const pw = (document.getElementById('r_pw').value || '');
  const pw2 = (document.getElementById('r_pw2').value || '');
  const msg = document.getElementById('regMsg'); msg.innerText = '';
  if (!/^[a-zA-Z0-9_-]{4,20}$/.test(id)){ msg.innerText='ì•„ì´ë””ëŠ” ì˜ë¬¸/ìˆ«ì 4~20ìì´ì–´ì•¼ í•©ë‹ˆë‹¤.'; return; }
  if (pw.length < 8){ msg.innerText='ë¹„ë°€ë²ˆí˜¸ëŠ” 8ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.'; return; }
  if (pw !== pw2){ msg.innerText='ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'; return; }
  if (state.users[id]){ msg.innerText='ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì•„ì´ë””ì…ë‹ˆë‹¤.'; return; }
  state.users[id] = { pw, notes: {}, connections: [], rooms: [] };
  persist();
  msg.innerText = 'íšŒì›ê°€ì… ì™„ë£Œ. ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.';
  setTimeout(()=>renderAuth(),700);
}
function doLogin(){
  const id = (document.getElementById('f_id').value || '').trim();
  const pw = (document.getElementById('f_pw').value || '');
  const msg = document.getElementById('authMsg'); msg.innerText = '';
  if (!state.users[id] || state.users[id].pw !== pw){ msg.innerText='ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.'; return; }
  currentUser = id; renderApp();
}

// ---------- APP ----------
function renderHeader(){
  document.getElementById('headerActions').innerHTML = `
    <div style="display:flex;gap:8px;align-items:center">
      <div class="small">${currentUser}ë‹˜</div>
      <button class="btn secondary" onclick="doLogout()">ë¡œê·¸ì•„ì›ƒ</button>
    </div>`;
}
function doLogout(){ currentUser = null; activeRoom = null; selectedDate = null; view.mode = 'calendar'; renderAuth(); document.getElementById('headerActions').innerHTML = ''; }

function renderApp(){ renderHeader();
  document.getElementById('content').innerHTML = `
  <div class="main">
    <div class="sidebar">
      <div class="card profile" style="padding:12px;margin-bottom:12px">
        <div class="profile">
          <div class="avatar">${currentUser.slice(0,1).toUpperCase()}</div>
          <div style="margin-left:8px">
            <div style="font-weight:700">${currentUser}ë‹˜</div>
            <div class="small">ê°œì¸ ìº˜ë¦°ë” Â· ì¹œêµ¬ ì—°ê²° Â· ì±„íŒ…</div>
          </div>
        </div>
      </div>

      <div class="card" style="padding:12px;margin-bottom:12px">
        <div class="small">ì—°ê²° (ì¹œêµ¬ ì¶”ê°€)</div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <input id="findId" placeholder="ì•„ì´ë””ë¡œ ê²€ìƒ‰" style="flex:1;padding:8px;border-radius:8px;border:1px solid #e6e9ef" />
          <button class="btn" onclick="searchAndAdd()">ì¶”ê°€</button>
        </div>
        <div id="connList" style="margin-top:10px"></div>
      </div>

      <div class="card" style="padding:12px">
        <div class="small">ì„ íƒëœ ë‚ ì§œ</div>
        <div id="selInfo" style="margin-top:8px">ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”.</div>
        <div style="margin-top:10px">
          <textarea id="noteInput" placeholder="ë©”ëª¨ë¥¼ ì‘ì„±í•˜ì„¸ìš”." style="width:100%;height:80px;border-radius:8px;padding:8px"></textarea>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn" onclick="addNote()">ì €ì¥</button>
            <button class="btn secondary" onclick="clearNotes()">ì‚­ì œ</button>
          </div>
        </div>
        <div id="noteList" class="memo-list" style="margin-top:10px"></div>
      </div>
    </div>

    <div>
      <div style="display:flex;gap:8px;margin-bottom:12px">
        <button class="btn" onclick="switchMode('calendar')">ìº˜ë¦°ë”</button>
        <button class="btn secondary" onclick="switchMode('chat')">ì±„íŒ…</button>
        <button class="btn" onclick="openCreateGroupModal()">ê·¸ë£¹ ë§Œë“¤ê¸°</button>
      </div>

      <div id="mainArea"></div>
    </div>
  </div>`;
  renderConnections(); renderMainArea();
}

// ---------- connections ----------
function renderConnections(){ const el = document.getElementById('connList'); el.innerHTML = ''; const list = (state.users[currentUser].connections || []); if(list.length===0){ el.innerHTML = '<div class="small">ì—°ê²°ëœ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.</div>'; return; } list.forEach(id=>{ const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.marginTop='6px'; row.innerHTML = `<div>${id}</div>`; const btn = document.createElement('button'); btn.className='btn secondary'; btn.innerText='ì±„íŒ…'; btn.onclick = ()=> openOneToOne(id); row.appendChild(btn); el.appendChild(row); }); }

function searchAndAdd(){ const id = (document.getElementById('findId').value || '').trim(); if(!id){ alert('ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”.'); return; } if(!state.users[id]){ alert('í•´ë‹¹ ì•„ì´ë””ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; } if(id === currentUser){ alert('ìê¸° ìì‹ ì€ ì¶”ê°€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; } const mine = state.users[currentUser]; mine.connections = mine.connections || []; const other = state.users[id]; other.connections = other.connections || []; if(mine.connections.includes(id)){ alert('ì´ë¯¸ ì—°ê²°ëœ ì‚¬ìš©ìì…ë‹ˆë‹¤.'); return; } mine.connections.push(id); other.connections.push(currentUser);
  const roomId = createOrGetDirectRoom(currentUser,id);
  persist(); renderConnections(); alert(id + 'ë‹˜ê³¼ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.'); }

function createOrGetDirectRoom(a,b){ const ids = [a,b].sort(); const key = 'dm--' + ids.join('--'); if(!state.chats[key]){ state.chats[key] = { id:key, name: ids.join(','), members: ids, messages: [] }; 
    state.users[a].rooms = state.users[a].rooms || []; state.users[b].rooms = state.users[b].rooms || []; if(!state.users[a].rooms.includes(key)) state.users[a].rooms.push(key); if(!state.users[b].rooms.includes(key)) state.users[b].rooms.push(key); persist(); }
  return key;
}

// ---------- main area (calendar / chat) ----------
function switchMode(m){ view.mode = m; renderMainArea(); }
function renderMainArea(){ 
  const area = document.getElementById('mainArea'); 
  if(view.mode === 'calendar'){
    area.innerHTML = `
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <button class="btn secondary" onclick="changeMonth(-1)">&lt; ì´ì „</button>
        <div style="font-weight:700" id="monthTitle"></div>
        <button class="btn secondary" onclick="changeMonth(1)">ë‹¤ìŒ &gt;</button>
      </div>
      <div class="small" style="margin-bottom:8px">ì´ë²ˆ ë‹¬ ë³´ê¸° Â· ë‚ ì§œ í´ë¦­ìœ¼ë¡œ ì„ íƒ</div>
      <div class="grid-days" id="calGrid"></div>
    </div>`;
    buildCalendar(view.year,view.month);
  } else {
    area.innerHTML = `
      <div class="card">
        <div style="display:flex;gap:12px">
          <div style="width:260px">
            <div class="small muted">ì±„íŒ… ë°©</div>
            <div id="roomList" style="margin-top:8px"></div>
          </div>
          <div style="flex:1">
            <div id="chatBox"></div>
          </div>
        </div>
      </div>`;
    renderRoomList(); renderChatBox();
  } 
}

// ---------- calendar ----------
function changeMonth(delta){
  view.month += delta;
  if(view.month < 0){ view.month = 11; view.year -= 1; }
  if(view.month > 11){ view.month = 0; view.year += 1; }
  buildCalendar(view.year, view.month);
}

function uidDate(y,m,d){ const mm = String(m+1).padStart(2,'0'); const dd = String(d).padStart(2,'0'); return `${y}-${mm}-${dd}`; }
function buildCalendar(y,m){ const grid = document.getElementById('calGrid'); if(!grid) return; document.getElementById('monthTitle').innerText = `${y}ë…„ ${m+1}ì›”`; grid.innerHTML = '';
  const first = new Date(y,m,1); const startDay = first.getDay(); const days = new Date(y,m+1,0).getDate(); const prevDays = new Date(y,m,0).getDate(); const total = startDay + days; const trailing = (7 - (total % 7)) % 7;
  for(let i=0;i<startDay;i++){ const d = prevDays - startDay + 1 + i; grid.appendChild(makeCell(y,m,d,true)); }
  for(let d=1; d<=days; d++){ grid.appendChild(makeCell(y,m,d,false)); }
  for(let i=1;i<=trailing;i++){ grid.appendChild(makeCell(y,m+1,i,true)); }
}
function makeCell(y,m,d,out=false){ const cell = document.createElement('div'); cell.className = 'cell' + (out? ' out' : ''); const dateDiv = document.createElement('div'); dateDiv.className = 'date'; dateDiv.innerText = d; const iso = (function(){ let dtY=y; let dtM=m; if(m<0){ dtY=y-1; dtM=11 } if(m>11){ dtY=y+1; dtM=0 } return uidDate(dtY,dtM,d); })(); cell.appendChild(dateDiv);
  const dots = document.createElement('div'); dots.className='dots'; const notes = (state.users[currentUser].notes || {})[iso] || []; if(notes.length>0){ dots.innerHTML = 'ğŸ“'; } cell.appendChild(dots);
  cell.onclick = ()=>{ if(out) return; selectedDate=iso; renderSelectedDate(); buildCalendar(view.year,view.month); }; if(selectedDate===iso){ cell.classList.add('selected'); } return cell;
}
function renderSelectedDate(){ const el = document.getElementById('selInfo'); if(!el) return; el.innerText = selectedDate || 'ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”.'; renderNotes(); }
function renderNotes(){ const list = document.getElementById('noteList'); if(!list) return; list.innerHTML=''; if(!selectedDate) return; const notes = (state.users[currentUser].notes || {})[selectedDate] || []; notes.forEach((n,i)=>{ const div = document.createElement('div'); div.className='memo-item'; div.innerText = n; list.appendChild(div); }); }
function addNote(){ if(!selectedDate) return alert('ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”.'); const text = document.getElementById('noteInput').value.trim(); if(!text) return; state.users[currentUser].notes[selectedDate] = state.users[currentUser].notes[selectedDate] || []; state.users[currentUser].notes[selectedDate].push(text); document.getElementById('noteInput').value=''; persist(); renderNotes(); buildCalendar(view.year,view.month); }
function clearNotes(){ if(!selectedDate) return; if(!state.users[currentUser].notes[selectedDate]) return; if(!confirm('ì„ íƒí•œ ë‚ ì§œì˜ ë©”ëª¨ë¥¼ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return; delete state.users[currentUser].notes[selectedDate]; persist(); renderNotes(); buildCalendar(view.year,view.month); }

// ---------- chat ----------
function renderRoomList(){ const el = document.getElementById('roomList'); if(!el) return; el.innerHTML=''; const rooms = state.users[currentUser].rooms || []; rooms.forEach(rid=>{ const room = state.chats[rid]; const row = document.createElement('div'); row.style.marginBottom='6px'; row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.innerHTML = `<div>${room.name}</div>`; const btn = document.createElement('button'); btn.className='btn secondary'; btn.innerText='ì…ì¥'; btn.onclick = ()=>{ activeRoom = rid; renderChatBox(); }; row.appendChild(btn); el.appendChild(row); }); }
function renderChatBox(){ const box = document.getElementById('chatBox'); if(!box) return; if(!activeRoom){ box.innerHTML='<div class="small muted">ì±„íŒ…ë°©ì„ ì„ íƒí•˜ì„¸ìš”.</div>'; return; } const room = state.chats[activeRoom]; box.innerHTML = `<div class="chat-window">
  <div class="messages" id="msgList"></div>
  <div style="display:flex;gap:6px;margin-top:6px">
    <input id="msgInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”." style="flex:1;padding:8px;border-radius:8px;border:1px solid #e6e9ef" />
    <button class="btn" onclick="sendMsg()">ì „ì†¡</button>
  </div></div>`; updateMsgList(); }
function updateMsgList(){ if(!activeRoom) return; const msgs = state.chats[activeRoom].messages; const el = document.getElementById('msgList'); el.innerHTML=''; msgs.forEach(m=>{ const div = document.createElement('div'); div.className='msg '+(m.from===currentUser?'me':'other'); div.innerText = m.from+': '+m.text; el.appendChild(div); }); el.scrollTop = el.scrollHeight; }
function sendMsg(){ const input = document.getElementById('msgInput'); if(!input) return; const text = input.value.trim(); if(!text) return; input.value=''; state.chats[activeRoom].messages.push({from:currentUser,text}); persist(); updateMsgList(); }

function openOneToOne(id){ activeRoom = createOrGetDirectRoom(currentUser,id); switchMode('chat'); }

function openCreateGroupModal(){ const name = prompt('ê·¸ë£¹ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.'); if(!name) return; const roomId = 'grp--'+Date.now(); state.chats[roomId] = { id:roomId, name, members:[currentUser], messages:[] }; state.users[currentUser].rooms.push(roomId); persist(); renderRoomList(); alert('ê·¸ë£¹ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.'); }

if(!currentUser) renderAuth();
</script>
</body>
</html>
