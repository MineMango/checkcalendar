<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>체크캘린더</title>
  <style>
    :root{ --bg:#f3f6fb; --card:#ffffff; --primary:#2f6bed; --accent:#2ab57a; --danger:#f06262; --muted:#6b7280; }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans KR',sans-serif;color:#111;background:var(--bg)}
    .wrap{max-width:980px;margin:32px auto;padding:20px}
    .header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    .brand{font-weight:700;font-size:20px}
    .card{background:var(--card);border-radius:12px;padding:18px;box-shadow:0 6px 18px rgba(30,40,60,0.06)}
    .auth{max-width:380px;margin:0 auto}
    label{display:block;font-size:13px;color:var(--muted);margin-top:12px}
    input[type=text],input[type=password],select,textarea{width:100%;padding:10px;border:1px solid #e6e9ef;border-radius:8px;margin-top:6px;font-size:14px}
    .row{display:flex;gap:10px}
    .row .col{flex:1}
    .muted{color:var(--muted);font-size:13px}
    .btn{display:inline-block;padding:10px 14px;border-radius:8px;border:none;background:var(--primary);color:#fff;font-weight:600;cursor:pointer;transition:transform .08s ease,box-shadow .08s;box-shadow:0 6px 12px rgba(47,107,237,0.18)}
    .btn:active{transform:translateY(1px) scale(0.995);box-shadow:0 3px 8px rgba(47,107,237,0.12)}
    .btn.secondary{background:#fff;color:var(--primary);border:1px solid #dbe4fb;box-shadow:none}
    .btn.positive{background:var(--accent);box-shadow:0 6px 12px rgba(42,181,122,0.14)}
    .btn.negative{background:var(--danger)}
    .main{display:grid;grid-template-columns:320px 1fr;gap:18px}
    .sidebar .profile{display:flex;align-items:center;gap:12px}
    .avatar{width:52px;height:52px;border-radius:10px;background:linear-gradient(135deg,#e6f0ff,#f3f8ff);display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--primary)}
    .meta{font-size:14px}
    .cal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    .nav{display:flex;gap:8px;align-items:center}
    .month-display{font-weight:700}
    .grid-week{display:flex;gap:6px;margin-bottom:6px}
    .grid-days{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
    .cell{background:var(--card);border-radius:8px;padding:10px;min-height:70px;cursor:pointer;border:1px solid #eef2f6;display:flex;flex-direction:column}
    .cell.out{opacity:0.35}
    .cell .date{font-weight:700}
    .cell .dots{margin-top:auto;display:flex;gap:6px;flex-wrap:wrap}
    .dot{width:8px;height:8px;border-radius:50%}
    .cell:hover{transform:translateY(-4px);transition:transform .12s}
    .selected{outline:3px solid rgba(47,107,237,0.12);box-shadow:0 8px 24px rgba(47,107,237,0.06)}
    .memo-list{margin-top:12px;display:flex;flex-direction:column;gap:8px}
    .memo-item{padding:10px;border-radius:8px;background:#fbfdff;border:1px solid #eef3ff}
    .small{font-size:13px;color:var(--muted)}
    /* chat */
    .chat-window{display:flex;flex-direction:column;height:520px}
    .messages{flex:1;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:8px;background:linear-gradient(180deg,#ffffff, #fbfdff);border-radius:8px;border:1px solid #eef3ff}
    .msg{padding:8px 10px;border-radius:8px;max-width:75%}
    .msg.me{align-self:flex-end;background:#e6f0ff}
    .msg.other{align-self:flex-start;background:#fff}
    .chat-input{display:flex;gap:8px;margin-top:8px}
    @media (max-width:880px){.main{grid-template-columns:1fr}.sidebar{order:2}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="brand">체크캘린더</div>
      <div id="headerActions"></div>
    </div>
    <div id="content"></div>
  </div>
<script>
const STORAGE_KEY = 'checkcalendar_users_v2';
let users = JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}');
let chats = users._chats || {};
let currentUser = null;
let view = { year: new Date().getFullYear(), month: new Date().getMonth(), mode: 'calendar' };
let selectedDate = null; // YYYY-MM-DD
let activeChatId = null;

function save(){ users._chats = chats; localStorage.setItem(STORAGE_KEY, JSON.stringify(users)); }
function uidDate(y,m,d){ const mm=String(m+1).padStart(2,'0'); const dd=String(d).padStart(2,'0'); return `${y}-${mm}-${dd}`; }

// --- auth ---
function renderAuth(){
  document.getElementById('content').innerHTML = `
  <div class="card auth">
    <h3 style="margin:0 0 8px 0">계정으로 시작</h3>
    <div class="muted">아이디와 비밀번호로 간편하게 이용하세요.</div>
    <label>아이디</label>
    <input id="f_id" type="text" placeholder="영문/숫자 조합" />
    <label>비밀번호</label>
    <input id="f_pw" type="password" placeholder="8자 이상" />
    <div style="display:flex;gap:8px;margin-top:12px">
      <button class="btn" onclick="doLogin()">로그인</button>
      <button class="btn secondary" onclick="renderRegister()">회원가입</button>
    </div>
    <div id="authMsg" class="muted" style="margin-top:10px"></div>
  </div>`;
  document.getElementById('headerActions').innerHTML = '';
}
function renderRegister(){
  document.getElementById('content').innerHTML = `
  <div class="card auth">
    <h3 style="margin:0 0 8px 0">새 계정 만들기</h3>
    <label>아이디</label>
    <input id="r_id" type="text" placeholder="영문/숫자 4~20자" />
    <label>비밀번호</label>
    <input id="r_pw" type="password" placeholder="8자 이상" />
    <label>비밀번호 확인</label>
    <input id="r_pw2" type="password" placeholder="다시 입력" />
    <div style="display:flex;gap:8px;margin-top:12px">
      <button class="btn positive" onclick="doRegister()">회원가입</button>
      <button class="btn secondary" onclick="renderAuth()">취소</button>
    </div>
    <div id="regMsg" class="muted" style="margin-top:10px"></div>
  </div>`;
  document.getElementById('headerActions').innerHTML = '';
}
function doRegister(){
  const id = document.getElementById('r_id').value.trim();
  const pw = document.getElementById('r_pw').value; const pw2 = document.getElementById('r_pw2').value; const msg=document.getElementById('regMsg'); msg.innerText='';
  if (!/^[a-zA-Z0-9_-]{4,20}$/.test(id)){ msg.innerText='아이디는 영문/숫자 4~20자이어야 합니다.'; return; }
  if (pw.length < 8){ msg.innerText='비밀번호는 8자 이상이어야 합니다.'; return; }
  if (pw !== pw2){ msg.innerText='비밀번호가 일치하지 않습니다.'; return; }
  if (users[id]){ msg.innerText='이미 존재하는 아이디입니다.'; return; }
  users[id] = { pw: pw, notes: {}, connections: [], chats: [] };
  save(); msg.innerText='회원가입 완료. 로그인 화면으로 이동합니다.'; setTimeout(()=>renderAuth(),700);
}
function doLogin(){ const id=document.getElementById('f_id').value.trim(); const pw=document.getElementById('f_pw').value; const msg=document.getElementById('authMsg'); msg.innerText=''; if(!users[id]||users[id].pw!==pw){ msg.innerText='아이디 또는 비밀번호가 올바르지 않습니다.'; return; } currentUser=id; renderApp(); }

// --- main ---
function renderHeader(){
  document.getElementById('headerActions').innerHTML = `
    <div style="display:flex;gap:8px;align-items:center">
      <div class="small" style="margin-right:8px">${currentUser}님</div>
      <button class="btn secondary" onclick="doLogout()">로그아웃</button>
    </div>`;
}

function renderApp(){ renderHeader(); document.getElementById('content').innerHTML = `
  <div class="main">
    <div class="sidebar">
      <div class="card profile" style="padding:14px;margin-bottom:12px">
        <div class="profile" style="align-items:flex-start">
          <div class="avatar">${currentUser.slice(0,1).toUpperCase()}</div>
          <div class="meta">
            <div style="font-weight:700">${currentUser}님</div>
            <div class="small">개인 캘린더 · 친구 연결 · 채팅</div>
          </div>
        </div>
      </div>

      <div class="card" style="padding:12px;margin-bottom:12px">
        <div class="muted">연결 (친구 추가)</div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <input id="findId" placeholder="아이디로 검색" />
          <button class="btn" onclick="searchAndAdd()">추가</button>
        </div>
        <div id="connList" style="margin-top:10px"></div>
      </div>

      <div class="card" style="padding:12px">
        <div class="muted">선택된 날짜</div>
        <div id="selInfo" style="margin-top:8px">날짜를 선택하세요.</div>
        <div style="margin-top:10px">
          <textarea id="noteInput" placeholder="메모를 작성하세요." style="width:100%;height:80px;border-radius:8px;padding:8px"></textarea>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn" onclick="addNote()">저장</button>
            <button class="btn secondary" onclick="clearNotes()">삭제</button>
          </div>
        </div>
        <div id="noteList" class="memo-list" style="margin-top:10px"></div>
      </div>
    </div>

    <div>
      <div style="display:flex;gap:8px;margin-bottom:12px">
        <button class="btn" onclick="switchMode('calendar')">캘린더</button>
        <button class="btn secondary" onclick="switchMode('chat')">채팅</button>
      </div>

      <div id="mainArea"></div>
    </div>
  </div>`;

  populateYearMonthSelectors(); buildCalendar(view.year, view.month); renderConnections(); renderMainArea();
}

function doLogout(){ currentUser=null; renderAuth(); document.getElementById('headerActions').innerHTML=''; }

// --- connections ---
function renderConnections(){ const el = document.getElementById('connList'); el.innerHTML=''; const list = users[currentUser].connections || []; if(list.length===0){ el.innerHTML='<div class="small">연결된 사용자가 없습니다.</div>'; return; } list.forEach(id=>{ const div=document.createElement('div'); div.style.display='flex'; div.style.justifyContent='space-between'; div.style.alignItems='center'; div.style.marginTop='6px'; div.innerHTML = `<div>${id}</div>`; const btn=document.createElement('button'); btn.className='btn secondary'; btn.innerText='채팅'; btn.onclick = ()=>{ openChatWith(id); }; div.appendChild(btn); el.appendChild(div); }); }

function searchAndAdd(){ const id=document.getElementById('findId').value.trim(); if(!id){ alert('아이디를 입력하세요.'); return; } if(!users[id]){ alert('해당 아이디가 없습니다.'); return; } if(id===currentUser){ alert('자기 자신은 추가할 수 없습니다.'); return; } if((users[currentUser].connections||[]).includes(id)){ alert('이미 연결된 사용자입니다.'); return; }
  users[currentUser].connections = users[currentUser].connections||[]; users[id].connections = users[id].connections||[]; users[currentUser].connections.push(id); users[id].connections.push(currentUser);
  // create chat id
  const chatId = [currentUser,id].sort().join('--'); if(!chats[chatId]){ chats[chatId] = { participants:[currentUser,id], messages:[] }; }
  save(); renderConnections(); alert(id+'님과 연결되었습니다.'); }

// --- main area (calendar / chat) ---
function switchMode(m){ view.mode = m; renderMainArea(); }
function renderMainArea(){ const area = document.getElementById('mainArea'); if(view.mode==='calendar'){ area.innerHTML = `
  <div class="card" style="padding:12px">
    <div class="cal-header">
      <div class="nav">
        <button class="btn secondary" onclick="prevMonth()">◀</button>
        <div class="month-display" id="monthTitle"></div>
        <button class="btn secondary" onclick="nextMonth()">▶</button>
      </div>
      <div class="small">이번 달 보기 · 날짜 클릭으로 선택</div>
    </div>
    <div class="grid-week small muted">
      <div style="width:14%;text-align:center">일</div>
      <div style="width:14%;text-align:center">월</div>
      <div style="width:14%;text-align:center">화</div>
      <div style="width:14%;text-align:center">수</div>
      <div style="width:14%;text-align:center">목</div>
      <div style="width:14%;text-align:center">금</div>
      <div style="width:14%;text-align:center">토</div>
    </div>
    <div id="calGrid" class="grid-days" style="margin-top:8px"></div>
  </div>`; buildCalendar(view.year,view.month); }
  else { area.innerHTML = `
    <div class="card" style="padding:12px">
      <div style="display:flex;gap:12px">
        <div style="width:260px">
          <div class="small muted">친구 목록</div>
          <div id="chatConnList" style="margin-top:8px"></div>
        </div>
        <div style="flex:1">
          <div id="chatBox"></div>
        </div>
      </div>
    </div>
  `; renderChatConnections(); renderChatBox(); }
}

function renderChatConnections(){ const el = document.getElementById('chatConnList'); el.innerHTML=''; const list = users[currentUser].connections||[]; if(list.length===0){ el.innerHTML='<div class="small">연결된 사용자가 없습니다.</div>'; return; } list.forEach(id=>{ const d=document.createElement('div'); d.style.display='flex'; d.style.justifyContent='space-between'; d.style.alignItems='center'; d.style.marginTop='6px'; d.innerHTML = `<div>${id}</div>`; const btn=document.createElement('button'); btn.className='btn'; btn.innerText='열기'; btn.onclick=()=>openChatWith(id); d.appendChild(btn); el.appendChild(d); }); }

function openChatWith(friendId){ const chatId = [currentUser,friendId].sort().join('--'); if(!chats[chatId]){ chats[chatId] = { participants:[currentUser,friendId], messages:[] }; save(); } activeChatId = chatId; view.mode='chat'; renderMainArea(); renderChatBox(); }

function renderChatBox(){ const box = document.getElementById('chatBox'); if(!activeChatId){ box.innerHTML = '<div class="small">채팅할 친구를 선택하세요.</div>'; return; } const chat = chats[activeChatId]; if(!chat){ box.innerHTML = '<div class="small">채팅 방이 없습니다.</div>'; return; }
  let html = `<div class="chat-window"><div class="small" style="margin-bottom:8px">참여자: ${chat.participants.join(', ')}</div><div id="messages" class="messages">`;
  chat.messages.forEach(m=>{ const who = m.from===currentUser? 'me':'other'; html += `<div class="msg ${who}"><div style="font-size:13px">${m.text}</div><div class="small" style="margin-top:6px">${new Date(m.ts).toLocaleString()}</div></div>`; });
  html += `</div><div class="chat-input"><input id="chatText" placeholder="메시지 입력" style="flex:1;padding:10px;border-radius:8px;border:1px solid #e6e9ef" /><button class="btn" onclick="sendMessage()">전송</button></div></div>`;
  box.innerHTML = html; const msgs = document.getElementById('messages'); msgs.scrollTop = msgs.scrollHeight;
}

function sendMessage(){ const txt = document.getElementById('chatText'); if(!txt || !txt.value.trim()) return; const text = txt.value.trim(); chats[activeChatId].messages.push({from:currentUser,text,ts:Date.now()}); save(); txt.value=''; renderChatBox(); }

// --- calendar ---
function populateYearMonthSelectors(){ const selY=document.getElementById('selYear'); const selM=document.getElementById('selMonth'); if(!selY||!selM) return; selY.innerHTML=''; selM.innerHTML=''; const year=new Date().getFullYear(); for(let y=year-3;y<=year+3;y++){ const opt=document.createElement('option'); opt.value=y; opt.innerText=y+'년'; if(y===view.year) opt.selected=true; selY.appendChild(opt); } for(let m=0;m<12;m++){ const opt=document.createElement('option'); opt.value=m; opt.innerText=(m+1)+'월'; if(m===view.month) opt.selected=true; selM.appendChild(opt); } selY.onchange=()=>{ view.year=parseInt(selY.value); buildCalendar(view.year,view.month); } selM.onchange=()=>{ view.month=parseInt(selM.value); buildCalendar(view.year,view.month); } }
function prevMonth(){ if(view.month===0){ view.month=11; view.year--; } else view.month--; buildCalendar(view.year,view.month); updateSelectors(); }
function nextMonth(){ if(view.month===11){ view.month=0; view.year++; } else view.month++; buildCalendar(view.year,view.month); updateSelectors(); }
function updateSelectors(){ const sY=document.getElementById('selYear'); const sM=document.getElementById('selMonth'); if(sY) sY.value=view.year; if(sM) sM.value=view.month; }
function buildCalendar(y,m){ const grid=document.getElementById('calGrid'); if(!grid) return; document.getElementById('monthTitle').innerText=`${y}년 ${m+1}월`; grid.innerHTML=''; const first=new Date(y,m,1); const startDay=first.getDay(); const days=new Date(y,m+1,0).getDate(); const prevDays=new Date(y,m,0).getDate(); const total = startDay + days; const trailing = (7-(total%7))%7; for(let i=0;i<startDay;i++){ const d=prevDays - startDay + 1 + i; grid.appendChild(makeCell(y,m,d,true)); } for(let d=1;d<=days;d++){ grid.appendChild(makeCell(y,m,d,false)); } for(let i=1;i<=trailing;i++){ grid.appendChild(makeCell(y,m+1,i,true)); } }
function makeCell(y,m,d,out=false){ const cell=document.createElement('div'); cell.className='cell'+(out?' out':''); const dateDiv=document.createElement('div'); dateDiv.className='date'; dateDiv.innerText=d; const iso=(function(){ let dtY=y; let dtM=m; if(m<0){ dtY=y-1; dtM=11 } if(m>11){ dtY=y+1; dtM=0 } return uidDate(dtY,dtM,d); })(); cell.appendChild(dateDiv); const dots=document.createElement('div'); dots.className='dots'; const userNotes = users[currentUser] && users[currentUser].notes && users[currentUser].notes[iso] ? users[currentUser].notes[iso] : []; userNotes.slice(0,6).forEach((n,i)=>{ const dot=document.createElement('div'); dot.className='dot'; dot.style.background = i%2? '#ffd166':'#2f6bed'; dots.appendChild(dot); }); cell.appendChild(dots); cell.onclick=()=>{ selectedDate=iso; document.querySelectorAll('.cell').forEach(c=>c.classList.remove('selected')); cell.classList.add('selected'); document.getElementById('selInfo').innerHTML = `<div style="font-weight:700">${iso}</div><div class="small">메모을 추가하거나 기존 메모를 관리하세요.</div>`; loadNotes(); }; return cell; }
// --- notes (private to user) ---
function addNote(){ if(!selectedDate){ alert('먼저 날짜를 선택하세요.'); return; } const text=document.getElementById('noteInput').value.trim(); if(!text) return; users[currentUser].notes[selectedDate]=users[currentUser].notes[selectedDate]||[]; users[currentUser].notes[selectedDate].push({text,created:Date.now()}); save(); document.getElementById('noteInput').value=''; loadNotes(); buildCalendar(view.year,view.month); }
function loadNotes(){ const container=document.getElementById('noteList'); if(!container) return; container.innerHTML=''; const notes = users[currentUser].notes[selectedDate]||[]; if(notes.length===0) container.innerHTML='<div class="small">메모가 없습니다.</div>'; notes.forEach((n,idx)=>{ const it=document.createElement('div'); it.className='memo-item'; it.innerHTML = `<div style="font-weight:700">${n.text}</div><div class="small">${new Date(n.created).toLocaleString()}</div>`; const del=document.createElement('button'); del.className='btn secondary'; del.style.marginTop='8px'; del.innerText='삭제'; del.onclick=()=>{ users[currentUser].notes[selectedDate].splice(idx,1); if(users[currentUser].notes[selectedDate].length===0) delete users[currentUser].notes[selectedDate]; save(); loadNotes(); buildCalendar(view.year,view.month); }; it.appendChild(del); container.appendChild(it); }); }
function clearNotes(){ if(!selectedDate) return; if(!confirm('이 날짜의 모든 메모를 삭제하시겠습니까?')) return; delete users[currentUser].notes[selectedDate]; save(); loadNotes(); buildCalendar(view.year,view.month); }

// --- chat persistence helper ---
function getChatsForUser(id){ const res = []; for(const cid in chats){ if(chats[cid].participants && chats[cid].participants.includes(id)) res.push([cid,chats[cid]]); } return res; }

// --- init ---
(function init(){ renderAuth();})();
</script>
<script>
// 그룹 채팅 시스템 추가
function createGroupChat(roomName, memberList) {
  const users = JSON.parse(localStorage.getItem('users')||'{}');
  const u = users[currentUser];
  const roomId = 'room_'+Date.now();
  const chats = JSON.parse(localStorage.getItem('_chats')||'{}');
  chats[roomId] = { name: roomName, members: memberList, messages: [] };
  localStorage.setItem('_chats', JSON.stringify(chats));
  if(!u.groupRooms) u.groupRooms=[];
  u.groupRooms.push(roomId);
  users[currentUser]=u;
  localStorage.setItem('users', JSON.stringify(users));
  renderChatList();
}
function openGroupRoom(roomId) {
  const chats = JSON.parse(localStorage.getItem('_chats')||'{}');
  const room = chats[roomId];
  if(!room) return;
  document.getElementById('chatRoomName').innerText = room.name + ' (그룹)';
  currentChatRoom = roomId;
  renderMessages();
  document.getElementById('calendarSection').style.display='none';
  document.getElementById('chatSection').style.display='flex';
}
</script>

<div id="groupCreateModal" class="modal hidden">
  <div class="modal-content">
    <h3>그룹 채팅 만들기</h3>
    <input id="groupRoomName" placeholder="그룹 이름" />
    <textarea id="groupMemberIds" placeholder="참여자 아이디 (쉼표로 구분)"></textarea>
    <button onclick="const name=document.getElementById('groupRoomName').value.trim();const ids=document.getElementById('groupMemberIds').value.split(',').map(x=>x.trim()).filter(x=>x);createGroupChat(name, [currentUser,...ids]);document.getElementById('groupCreateModal').classList.add('hidden');">생성</button>
    <button onclick="document.getElementById('groupCreateModal').classList.add('hidden')">닫기</button>
  </div>
</div>
</body>
</html>
