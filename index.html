<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>체크캘린더</title>
  <style>
    :root{--bg:#f3f6fb;--card:#fff;--primary:#2f6bed;--accent:#2ab57a;--danger:#f06262;--muted:#6b7280}
    *{box-sizing:border-box}
    body,html{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans KR',sans-serif;background:var(--bg);color:#111}
    .wrap{max-width:980px;margin:28px auto;padding:18px}
    .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    .brand{font-weight:700;font-size:20px}
    .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 6px 18px rgba(30,40,60,0.06)}
    .btn{padding:8px 12px;border-radius:8px;border:none;background:var(--primary);color:#fff;font-weight:600;cursor:pointer}
    .btn.secondary{background:#fff;color:var(--primary);border:1px solid #dbe4fb}
    .btn.positive{background:var(--accent)}
    .btn.negative{background:var(--danger)}
    .small{font-size:13px;color:var(--muted)}
    .main{display:grid;grid-template-columns:300px 1fr;gap:16px}
    .sidebar .profile{display:flex;gap:12px;align-items:center}
    .avatar{width:48px;height:48px;border-radius:10px;background:linear-gradient(135deg,#e6f0ff,#f3f8ff);display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--primary)}
    .grid-days{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-top:8px}
    .cell{background:var(--card);border-radius:8px;padding:8px;min-height:70px;border:1px solid #eef2f6;display:flex;flex-direction:column;cursor:pointer}
    .cell.out{opacity:0.35}
    .cell:hover{transform:translateY(-4px);transition:transform .12s}
    .selected{outline:3px solid rgba(47,107,237,0.12);box-shadow:0 8px 24px rgba(47,107,237,0.06)}
    .memo-list{display:flex;flex-direction:column;gap:8px;margin-top:10px}
    .memo-item{padding:8px;border-radius:8px;background:#fbfdff;border:1px solid #eef3ff}
    .chat-window{display:flex;flex-direction:column;height:420px}
    .messages{flex:1;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:8px;border-radius:8px;border:1px solid #eef3ff;background:linear-gradient(180deg,#fff,#fbfdff)}
    .msg{padding:8px 10px;border-radius:8px;max-width:75%}
    .msg.me{align-self:flex-end;background:#e6f0ff}
    .msg.other{align-self:flex-start;background:#fff}
    @media (max-width:880px){.main{grid-template-columns:1fr}.sidebar{order:2}}
    .modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.35)}
    .modal .inner{background:var(--card);padding:16px;border-radius:10px;min-width:320px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="brand">체크캘린더</div>
      <div id="headerActions"></div>
    </div>

    <div id="content"></div>
  </div>

<script>
const STORAGE_KEY = 'checkcalendar_v4';
let state = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
state.users = state.users || {}; 
state.chats = state.chats || {}; 
let currentUser = null;
let view = { year: new Date().getFullYear(), month: new Date().getMonth(), mode: 'calendar' };
let selectedDate = null; 
let activeRoom = null;

function persist(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

// ---------- AUTH ----------
function renderAuth(){
  document.getElementById('content').innerHTML = `
    <div class="card" style="max-width:420px;margin:0 auto">
      <h3>계정으로 시작</h3>
      <div class="small">아이디와 비밀번호로 간편하게 이용하세요.</div>
      <label class="small">아이디</label>
      <input id="f_id" type="text" style="width:100%;padding:8px;border-radius:8px;border:1px solid #e6e9ef;margin-top:6px" />
      <label class="small">비밀번호</label>
      <input id="f_pw" type="password" style="width:100%;padding:8px;border-radius:8px;border:1px solid #e6e9ef;margin-top:6px" />
      <div style="display:flex;gap:8px;margin-top:12px">
        <button class="btn" onclick="doLogin()">로그인</button>
        <button class="btn secondary" onclick="renderRegister()">회원가입</button>
      </div>
      <div id="authMsg" class="small" style="margin-top:10px;color:var(--muted)"></div>
    </div>`;
  document.getElementById('headerActions').innerHTML = '';
}

function renderRegister(){
  document.getElementById('content').innerHTML = `
    <div class="card" style="max-width:420px;margin:0 auto">
      <h3>새 계정 만들기</h3>
      <label class="small">아이디</label>
      <input id="r_id" type="text" style="width:100%;padding:8px;border-radius:8px;border:1px solid #e6e9ef;margin-top:6px" />
      <label class="small">비밀번호</label>
      <input id="r_pw" type="password" style="width:100%;padding:8px;border-radius:8px;border:1px solid #e6e9ef;margin-top:6px" />
      <label class="small">비밀번호 확인</label>
      <input id="r_pw2" type="password" style="width:100%;padding:8px;border-radius:8px;border:1px solid #e6e9ef;margin-top:6px" />
      <div style="display:flex;gap:8px;margin-top:12px">
        <button class="btn positive" onclick="doRegister()">회원가입</button>
        <button class="btn secondary" onclick="renderAuth()">취소</button>
      </div>
      <div id="regMsg" class="small" style="margin-top:10px;color:var(--muted)"></div>
    </div>`;
  document.getElementById('headerActions').innerHTML = '';
}

function doRegister(){
  const id = (document.getElementById('r_id').value || '').trim();
  const pw = (document.getElementById('r_pw').value || '');
  const pw2 = (document.getElementById('r_pw2').value || '');
  const msg = document.getElementById('regMsg'); msg.innerText = '';
  if (!/^[a-zA-Z0-9_-]{4,20}$/.test(id)){ msg.innerText='아이디는 영문/숫자 4~20자이어야 합니다.'; return; }
  if (pw.length < 8){ msg.innerText='비밀번호는 8자 이상이어야 합니다.'; return; }
  if (pw !== pw2){ msg.innerText='비밀번호가 일치하지 않습니다.'; return; }
  if (state.users[id]){ msg.innerText='이미 존재하는 아이디입니다.'; return; }
  state.users[id] = { pw, notes: {}, connections: [], rooms: [] };
  persist();
  msg.innerText = '회원가입 완료. 로그인 화면으로 이동합니다.';
  setTimeout(()=>renderAuth(),700);
}

function doLogin(){
  const id = (document.getElementById('f_id').value || '').trim();
  const pw = (document.getElementById('f_pw').value || '');
  const msg = document.getElementById('authMsg'); msg.innerText = '';
  if (!state.users[id] || state.users[id].pw !== pw){ msg.innerText='아이디 또는 비밀번호가 올바르지 않습니다.'; return; }
  currentUser = id; renderApp();
}

// ---------- HEADER ----------
function renderHeader(){
  document.getElementById('headerActions').innerHTML = `
    <div style="display:flex;gap:8px;align-items:center">
      <div class="small">${currentUser}님</div>
      <button class="btn secondary" onclick="doLogout()">로그아웃</button>
    </div>`;
}

function doLogout(){ currentUser = null; activeRoom = null; selectedDate = null; view.mode='calendar'; renderAuth(); }

// ---------- APP ----------
function renderApp(){ 
  renderHeader();
  document.getElementById('content').innerHTML = `
  <div class="main">
    <div class="sidebar">
      <div class="card profile" style="padding:12px;margin-bottom:12px">
        <div class="profile">
          <div class="avatar">${currentUser.slice(0,1).toUpperCase()}</div>
          <div style="margin-left:8px">
            <div style="font-weight:700">${currentUser}님</div>
            <div class="small">친구 달력 · 채팅</div>
          </div>
        </div>
      </div>

      <div class="card" style="padding:12px;margin-bottom:12px">
        <div class="small">연결 (친구 추가)</div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <input id="findId" placeholder="아이디로 검색" style="flex:1;padding:8px;border-radius:8px;border:1px solid #e6e9ef" />
          <button class="btn" onclick="searchAndAdd()">추가</button>
        </div>
        <div id="connList" style="margin-top:10px"></div>
      </div>

      <div class="card" style="padding:12px">
        <div class="small">선택된 날짜</div>
        <div id="selInfo" style="margin-top:8px">날짜를 선택하세요.</div>
        <div style="margin-top:10px">
          <textarea id="noteInput" placeholder="메모를 작성하세요." style="width:100%;height:80px;border-radius:8px;padding:8px"></textarea>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn" onclick="addNote()">저장</button>
            <button class="btn secondary" onclick="clearNotes()">삭제</button>
          </div>
        </div>
        <div id="noteList" class="memo-list" style="margin-top:10px"></div>
      </div>
    </div>

    <div>
      <div style="display:flex;gap:8px;margin-bottom:12px">
        <button class="btn" onclick="switchMode('calendar')">캘린더</button>
        <button class="btn secondary" onclick="switchMode('chat')">채팅</button>
        <button class="btn" onclick="openCreateGroupModal()">그룹 만들기</button>
      </div>

      <div id="mainArea"></div>
    </div>
  </div>`;
  renderConnections(); renderMainArea();
}

// ---------- CONNECTIONS ----------
function renderConnections(){ 
  const el = document.getElementById('connList'); el.innerHTML = ''; 
  const list = (state.users[currentUser].connections || []); 
  if(list.length===0){ el.innerHTML = '<div class="small">연결된 사용자가 없습니다.</div>'; return; } 
  list.forEach(id=>{
    const row = document.createElement('div'); 
    row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.marginTop='6px'; 
    row.innerHTML = `<div>${id}</div>`; 
    const btn = document.createElement('button'); 
    btn.className='btn secondary'; 
    btn.innerText='채팅'; 
    btn.onclick = ()=> openOneToOne(id); 
    row.appendChild(btn); 
    el.appendChild(row); 
  }); 
}

function searchAndAdd(){ 
  const id = (document.getElementById('findId').value || '').trim(); 
  if(!id){ alert('아이디를 입력하세요.'); return; } 
  if(!state.users[id]){ alert('해당 아이디가 없습니다.'); return; } 
  if(id === currentUser){ alert('자기 자신은 추가할 수 없습니다.'); return; } 
  const mine = state.users[currentUser]; 
  mine.connections = mine.connections || []; 
  const other = state.users[id]; 
  other.connections = other.connections || []; 
  if(mine.connections.includes(id)){ alert('이미 연결된 사용자입니다.'); return; } 
  mine.connections.push(id); 
  other.connections.push(currentUser);
  persist(); renderConnections(); alert(id + '님과 연결되었습니다.'); 
}

// ---------- MAIN AREA ----------
function switchMode(m){ view.mode = m; renderMainArea(); }

function renderMainArea(){ 
  const area = document.getElementById('mainArea'); 
  if(view.mode === 'calendar'){ 
    area.innerHTML = `
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:700" id="monthTitle"></div>
          <div class="small">이번 달 보기 · 날짜 클릭으로 선택</div>
        </div>
        <div class="grid-days" id="calGrid"></div>
      </div>`;
    buildCalendar(view.year,view.month);
  } else {
    area.innerHTML = `
      <div class="card">
        <div style="display:flex;gap:12px">
          <div style="width:260px">
            <div class="small muted">채팅 방</div>
            <div id="roomList" style="margin-top:8px"></div>
          </div>
          <div style="flex:1">
            <div id="chatBox"></div>
          </div>
        </div>
      </div>`;
    renderRoomList(); renderChatBox();
  } 
}

// ---------- CALENDAR ----------
function uidDate(y,m,d){ const mm = String(m+1).padStart(2,'0'); const dd = String(d).padStart(2,'0'); return `${y}-${mm}-${dd}`; }

function buildCalendar(y,m){ 
  const grid = document.getElementById('calGrid'); 
  if(!grid) return; 
  document.getElementById('monthTitle').innerText = `${y}년 ${m+1}월`; 
  grid.innerHTML = '';
  const first = new Date(y,m,1); 
  const startDay = first.getDay(); 
  const days = new Date(y,m+1,0).getDate(); 
  const prevDays = new Date(y,m,0).getDate(); 
  const total = startDay + days; 
  const trailing = (7 - (total % 7)) % 7;

  for(let i=0;i<startDay;i++){ const d = prevDays - startDay + 1 + i; grid.appendChild(makeCell(y,m,d,true)); }
  for(let d=1; d<=days; d++){ grid.appendChild(makeCell(y,m,d,false)); }
  for(let i=1;i<=trailing;i++){ grid.appendChild(makeCell(y,m+1,i,true)); }
}

function makeCell(y,m,d,out=false){ 
  const cell = document.createElement('div'); 
  cell.className = 'cell' + (out? ' out' : ''); 
  const dateDiv = document.createElement('div'); 
  dateDiv.className = 'date'; 
  dateDiv.innerText = d; 
  const iso = (function(){ let dtY=y; let dtM=m; if(m<0){ dtY=y-1; dtM=11 } if(m>11){ dtY=y+1; dtM=0 } return uidDate(dtY,dtM,d); })(); 
  cell.appendChild(dateDiv);

  const dots = document.createElement('div'); dots.className='dots'; 
  const friends = [currentUser, ...(state.users[currentUser].connections||[])];
  const notes = friends.flatMap(f => ((state.users[f].notes||{})[iso]||[])); 
  notes.slice(0,6).forEach((n,i)=>{ const dot = document.createElement('div'); dot.style.width='8px'; dot.style.height='8px'; dot.style.borderRadius='50%'; dot.style.background = i%2? '#ffd166':'#2f6bed'; dot.style.marginRight='4px'; dots.appendChild(dot); }); 
  cell.appendChild(dots);

  cell.onclick = ()=>{ selectedDate = iso; document.querySelectorAll('.cell').forEach(c=>c.classList.remove('selected')); cell.classList.add('selected'); 
    loadNotes(); 
    document.getElementById('selInfo').innerHTML = `<div style="font-weight:700">${iso}</div><div class="small">친구 달력 및 메
    document.getElementById('selInfo').innerHTML = `<div style="font-weight:700">${iso}</div><div class="small">친구 달력 및 메모 보기</div>`;
  };
  return cell;
}

// ---------- NOTES ----------
function loadNotes(){ 
  const list = document.getElementById('noteList'); 
  list.innerHTML=''; 
  if(!selectedDate) return; 
  const friends = [currentUser, ...(state.users[currentUser].connections||[])];
  let allNotes = [];
  friends.forEach(f=>{
    const notes = (state.users[f].notes||{})[selectedDate]||[];
    notes.forEach(n=>{
      allNotes.push({user:f,text:n});
    });
  });
  if(allNotes.length===0){ list.innerHTML='<div class="small">메모가 없습니다.</div>'; return; }
  allNotes.forEach(n=>{
    const div = document.createElement('div'); 
    div.className='memo-item'; 
    div.innerHTML=`<b>${n.user}:</b> ${n.text}`; 
    list.appendChild(div);
  });
}

function addNote(){ 
  const val = document.getElementById('noteInput').value.trim(); 
  if(!val || !selectedDate) return; 
  state.users[currentUser].notes[selectedDate] = state.users[currentUser].notes[selectedDate] || []; 
  state.users[currentUser].notes[selectedDate].push(val); 
  document.getElementById('noteInput').value=''; 
  persist(); 
  loadNotes(); 
  buildCalendar(view.year,view.month);
}

function clearNotes(){ 
  if(!selectedDate) return; 
  state.users[currentUser].notes[selectedDate]=[]; 
  persist(); 
  loadNotes(); 
  buildCalendar(view.year,view.month);
}

// ---------- CHAT ----------
function openCreateGroupModal(){
  const modal = document.createElement('div'); 
  modal.className='modal'; 
  modal.innerHTML = `
    <div class="inner">
      <h4>그룹 채팅 만들기</h4>
      <div class="small">참여할 사용자 아이디를 쉼표로 구분</div>
      <input id="groupUsers" style="width:100%;padding:8px;margin-top:6px;border-radius:8px;border:1px solid #e6e9ef" placeholder="user1,user2" />
      <div style="display:flex;gap:8px;margin-top:12px">
        <button class="btn" id="createGroupBtn">만들기</button>
        <button class="btn secondary" onclick="document.body.removeChild(this.parentElement.parentElement)">취소</button>
      </div>
    </div>`;
  document.body.appendChild(modal);
  modal.querySelector('#createGroupBtn').onclick = ()=>{
    const val = modal.querySelector('#groupUsers').value.split(',').map(s=>s.trim()).filter(s=>s);
    const valid = val.every(u=>state.users[u]); 
    if(!valid){ alert('존재하지 않는 아이디가 있습니다.'); return; }
    const roomId = 'room_' + Date.now();
    state.chats[roomId] = {members:[currentUser,...val], messages:[]};
    persist(); document.body.removeChild(modal); renderRoomList(); 
    activeRoom = roomId; renderChatBox();
  };
}

function openOneToOne(userId){
  const roomId = Object.keys(state.chats).find(r=>state.chats[r].members.length===2 && state.chats[r].members.includes(currentUser) && state.chats[r].members.includes(userId));
  if(roomId){ activeRoom = roomId; } 
  else { 
    const id = 'room_' + Date.now(); 
    state.chats[id]={members:[currentUser,userId],messages:[]}; 
    persist(); activeRoom = id; 
  }
  renderRoomList(); renderChatBox();
}

function renderRoomList(){
  const el = document.getElementById('roomList'); 
  el.innerHTML=''; 
  const rooms = Object.keys(state.chats).filter(r=>state.chats[r].members.includes(currentUser));
  if(rooms.length===0){ el.innerHTML='<div class="small">채팅방이 없습니다.</div>'; return; }
  rooms.forEach(r=>{
    const btn = document.createElement('button'); 
    btn.className='btn secondary'; 
    btn.style.width='100%'; 
    btn.style.marginTop='4px';
    btn.innerText = state.chats[r].members.filter(m=>m!==currentUser).join(', '); 
    btn.onclick=()=>{ activeRoom=r; renderChatBox(); };
    if(r===activeRoom) btn.style.background='#2f6bed'; btn.style.color=r===activeRoom?'#fff':'';
    el.appendChild(btn);
  });
}

function renderChatBox(){
  const el = document.getElementById('chatBox'); 
  if(!el) return; 
  if(!activeRoom){ el.innerHTML='<div class="small">채팅방을 선택하세요.</div>'; return; }
  const room = state.chats[activeRoom]; 
  el.innerHTML = `
    <div class="chat-window">
      <div class="messages" id="msgList"></div>
      <div style="display:flex;gap:6px;margin-top:6px">
        <input id="msgInput" style="flex:1;padding:8px;border-radius:8px;border:1px solid #e6e9ef" placeholder="메시지 입력" />
        <button class="btn" onclick="sendMsg()">전송</button>
      </div>
    </div>`;
  loadMsgs();
}

function loadMsgs(){
  const list = document.getElementById('msgList'); 
  list.innerHTML=''; 
  if(!activeRoom) return; 
  const msgs = state.chats[activeRoom].messages || []; 
  msgs.forEach(m=>{
    const div = document.createElement('div'); 
    div.className='msg ' + (m.user===currentUser?'me':'other'); 
    div.innerText = m.user + ': ' + m.text; 
    list.appendChild(div);
  });
  list.scrollTop = list.scrollHeight;
}

function sendMsg(){
  const inp = document.getElementById('msgInput'); 
  const val = inp.value.trim(); 
  if(!val || !activeRoom) return; 
  state.chats[activeRoom].messages.push({user:currentUser,text:val}); 
  persist(); inp.value=''; loadMsgs();
}

// ---------- INIT ----------
if(currentUser){ renderApp(); } else { renderAuth(); }
</script>
</body>
</html>
